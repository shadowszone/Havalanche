<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connect Wallet - Havalanche</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Mobile-friendly Web3 Connection -->
  <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.1/dist/metamask-onboarding.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #ffffff;
      text-align: center;
      padding: 40px 20px;
      animation: fadeIn 1.5s ease-in;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    p {
      font-size: 1rem;
      margin-bottom: 2rem;
      color: #d0d0d0;
    }

    #connect {
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: bold;
      background-color: #e84142;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #connect:hover {
      background-color: #cf3434;
    }

    .logo {
      width: 100px;
      margin: 0 auto 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #address {
      margin-top: 1rem;
      font-size: 1rem;
      color: #aaffaa;
    }

    #mobile-warning {
      display: none;
      background: #e84142;
      padding: 10px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <img src="1000291145-removebg-preview.png" alt="Avalanche Logo" class="logo" />
  <h1>Welcome to Havalanche</h1>
  <p>Your decentralized guardian for safe and secure interactions on the Avalanche blockchain.</p>

  <button id="connect">Connect Wallet</button>
  <div id="address"></div>
  <div id="mobile-warning"></div>

  <script>
    // Telegram WebApp integration
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
    }

    // Mobile detection and handling
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const warningElement = document.getElementById('mobile-warning');
    let onboarding;

    // Initialize MetaMask onboarding
    if (!window.ethereum) {
      onboarding = new MetaMaskOnboarding();
    }

    // Connection Handler
    document.getElementById('connect').onclick = async () => {
      const button = document.getElementById('connect');
      
      if (window.ethereum?.selectedAddress) {
        // Disconnect
        window.ethereum.selectedAddress = null;
        document.getElementById('address').innerText = '';
        button.innerText = "Connect Wallet";
        return;
      }

      try {
        if (isMobile) {
          if (window.ethereum) {
            await connectWallet();
          } else {
            // Mobile without injected provider
            warningElement.style.display = 'block';
            warningElement.innerHTML = `
              Please open in:<br>
              <a href="https://metamask.app.link/browser/${encodeURIComponent(window.location.href)}" style="color: white;">
                MetaMask Browser
              </a><br>or<br>
              <a href="https://trustwallet.com/browser?url=${encodeURIComponent(window.location.href)}" style="color: white;">
                Trust Wallet Browser
              </a>
            `;
          }
        } else {
          // Desktop flow
          if (window.ethereum) {
            await connectWallet();
          } else {
            // No MetaMask - start onboarding
            onboarding.startOnboarding();
          }
        }
      } catch (error) {
        console.error("Connection error:", error);
        alert("Failed to connect wallet. Please try again.");
      }
    };

    async function connectWallet() {
      const button = document.getElementById('connect');
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const address = await signer.getAddress();

        document.getElementById('address').innerText = `Connected: ${address}`;
        button.innerText = "Disconnect";
        warningElement.style.display = 'none';

        // Send to Telegram if available
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.sendData(JSON.stringify({ address }));
        }

        // Listen for account changes
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            // Disconnected
            document.getElementById('address').innerText = '';
            button.innerText = "Connect Wallet";
          } else {
            // Account changed
            document.getElementById('address').innerText = `Connected: ${accounts[0]}`;
          }
        });

      } catch (error) {
        if (error.code === 4001) {
          // User rejected connection
          alert("Please connect your wallet to continue.");
        }
        throw error;
      }
    }

    // Auto-connect if already connected
    if (window.ethereum?.selectedAddress) {
      document.getElementById('address').innerText = `Connected: ${window.ethereum.selectedAddress}`;
      document.getElementById('connect').innerText = "Disconnect";
    }

    // Listen for mobile app installs
    if (isMobile && !window.ethereum) {
      window.addEventListener('ethereum#initialized', () => {
        window.location.reload();
      }, { once: true });
      
      // Timeout check for mobile providers
      setTimeout(() => {
        if (!window.ethereum) {
          warningElement.style.display = 'block';
          warningElement.textContent = "Please open in a Web3 browser like MetaMask or Trust Wallet";
        }
      }, 1000);
    }
  </script>
</body>
</html>
