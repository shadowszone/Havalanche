<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connect Wallet - Havalanche</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #ffffff;
      text-align: center;
      padding: 40px 20px;
      animation: fadeIn 1.5s ease-in;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    p {
      font-size: 1rem;
      margin-bottom: 2rem;
      color: #d0d0d0;
    }

    #connect {
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: bold;
      background-color: #e84142;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #connect:hover {
      background-color: #cf3434;
    }

    .logo {
      width: 100px;
      margin: 0 auto 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #address {
      margin-top: 1rem;
      font-size: 1rem;
      color: #aaffaa;
    }

    #mobile-warning {
      display: none;
      background: #e84142;
      padding: 10px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 300px;
    }

    #wallet-options {
      display: none;
      margin-top: 20px;
    }

    .wallet-btn {
      background: #2c5364;
      border: 1px solid #0f2027;
      color: white;
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      width: 200px;
      transition: all 0.3s ease;
    }

    .wallet-btn:hover {
      background: #203a43;
    }

    .wallet-btn img {
      width: 20px;
      vertical-align: middle;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <img src="1000291145-removebg-preview.png" alt="Avalanche Logo" class="logo" />
  <h1>Welcome to Havalanche</h1>
  <p>Your decentralized guardian for safe and secure interactions on the Avalanche blockchain.</p>

  <button id="connect">Connect Wallet</button>
  <div id="address"></div>
  <div id="mobile-warning"></div>
  
  <div id="wallet-options">
    <button class="wallet-btn" data-wallet="metamask">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask"> MetaMask
    </button>
    <button class="wallet-btn" data-wallet="trust">
      <img src="https://trustwallet.com/assets/images/media/assets/TWT.png" alt="Trust Wallet"> Trust Wallet
    </button>
    <button class="wallet-btn" data-wallet="core">
      <img src="https://core.app/favicon.ico" alt="Core Wallet"> Core Wallet
    </button>
  </div>

  <script>
    // Telegram WebApp integration
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
    }

    // Mobile detection
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const warningElement = document.getElementById('mobile-warning');
    const walletOptions = document.getElementById('wallet-options');

    // Core Wallet deep link
    function connectCoreWallet() {
      if (isMobile) {
        // Mobile deep link
        window.location.href = `https://core.app/wc?uri=${encodeURIComponent(window.location.href)}`;
      } else {
        // Desktop flow
        if (window.avalanche) {
          connectWallet();
        } else {
          window.open("https://core.app/download", "_blank");
        }
      }
    }

    // Connection Handler
    document.getElementById('connect').onclick = async () => {
      if (window.ethereum?.selectedAddress || window.avalanche?.isConnected?.()) {
        // Disconnect
        document.getElementById('address').innerText = '';
        document.getElementById('connect').innerText = "Connect Wallet";
        walletOptions.style.display = 'none';
        return;
      }

      // Show wallet options on mobile
      if (isMobile) {
        walletOptions.style.display = 'block';
        return;
      }

      // Desktop flow
      try {
        if (window.ethereum) {
          await connectWallet();
        } else {
          walletOptions.style.display = 'block';
        }
      } catch (error) {
        console.error("Connection error:", error);
        alert("Failed to connect wallet. Please try again.");
      }
    };

    // Wallet option handlers
    document.querySelectorAll('.wallet-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        walletOptions.style.display = 'none';
        const walletType = btn.getAttribute('data-wallet');
        
        try {
          if (walletType === 'metamask') {
            if (isMobile) {
              window.location.href = `https://metamask.app.link/browser/${encodeURIComponent(window.location.href)}`;
            } else if (window.ethereum) {
              await connectWallet();
            }
          } else if (walletType === 'trust') {
            if (isMobile) {
              window.location.href = `https://link.trustwallet.com/open_url?url=${encodeURIComponent(window.location.href)}`;
            } else {
              alert("Please install Trust Wallet extension for desktop");
            }
          } else if (walletType === 'core') {
            connectCoreWallet();
          }
        } catch (error) {
          console.error(`${walletType} connection error:`, error);
          alert(`Failed to connect ${walletType}. Please try again.`);
        }
      });
    });

    async function connectWallet() {
      const button = document.getElementById('connect');
      try {
        let provider;
        
        // Check for Core first
        if (window.avalanche) {
          provider = window.avalanche;
        } 
        // Then check for MetaMask/Trust
        else if (window.ethereum) {
          provider = window.ethereum;
        } else {
          throw new Error("No wallet provider found");
        }

        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        const ethersProvider = new ethers.providers.Web3Provider(provider);
        const signer = ethersProvider.getSigner();
        const address = await signer.getAddress();

        document.getElementById('address').innerText = `Connected: ${address}`;
        button.innerText = "Disconnect";
        warningElement.style.display = 'none';

        // Send to Telegram if available
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.sendData(JSON.stringify({ address }));
        }

        // Listen for account changes
        provider.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            // Disconnected
            document.getElementById('address').innerText = '';
            button.innerText = "Connect Wallet";
          } else {
            // Account changed
            document.getElementById('address').innerText = `Connected: ${accounts[0]}`;
          }
        });

      } catch (error) {
        if (error.code === 4001) {
          // User rejected connection
          alert("Please connect your wallet to continue.");
        }
        throw error;
      }
    }

    // Auto-connect if already connected
    if (window.ethereum?.selectedAddress) {
      document.getElementById('address').innerText = `Connected: ${window.ethereum.selectedAddress}`;
      document.getElementById('connect').innerText = "Disconnect";
    } else if (window.avalanche?.selectedAddress) {
      document.getElementById('address').innerText = `Connected: ${window.avalanche.selectedAddress}`;
      document.getElementById('connect').innerText = "Disconnect";
    }

    // Mobile detection fallback
    if (isMobile && !window.ethereum && !window.avalanche) {
      setTimeout(() => {
        if (!window.ethereum && !window.avalanche) {
          walletOptions.style.display = 'block';
        }
      }, 1000);
    }
  </script>
</body>
</html>
